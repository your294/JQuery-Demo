<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <title>jQuery + Template 动态列表</title>
    <style>
      .item {
        border: 1px solid #ddd;
        padding: 12px;
        margin: 8px 0;
        background: #fafafa;
      }

      .item input {
        margin-right: 10px;
        width: 130px;
        padding: 4px;
      }

      button {
        margin: 5px;
        padding: 6px 10px;
      }
      .none {
        display: none;
      }
    </style>
  </head>

  <body>
    <h2>用户信息列表（jQuery 版）</h2>
    <button id="consoleBtn">展示数据</button>

    <ul id="list"></ul>

    <!-- 模板：不会被渲染 -->
    <template id="item-template">
      <li class="item">
        <label
          >姓名：<input type="text" class="name-input" placeholder="姓名"
        /></label>
        <label
          >邮箱：<input type="email" class="email-input" placeholder="邮箱"
        /></label>
        <button class="add-btn">添加</button>
        <button class="remove-btn">删除</button>
        <div class="error none"></div>
      </li>
    </template>

    <script src="../dist/jquery.js"></script>
    <script src="../js/validate.js"></script>
    <script src="../mock/getPrizeList.js"></script>
    <script src="../js/prizelist.js"></script>
    <script>
      $(function () {
        const $list = $("#list");
        const $template = $("#item-template");
        // 为列表设置列表渲染数据
        $list.data("prize-list", []);

        // 通过事件委托统一为列表项的添加和删除按钮添加事件
        $list.on("click", ".add-btn", function (e) {
          // DOM插入新列表项
          const targetItem = $(e.target).closest(".item");
          const clone = document.importNode($template[0].content, true);
          const $clone = $(clone); // 转为jquery对象
          $clone.insertAfter(targetItem);

          // 更新列表数据
          /** @type {Array} **/
          const prizeList = $list.data("prize-list");
          const targetIdx = $("#list .item").index(targetItem);
          const newPrizeList = prizeList
            .slice(0, targetIdx + 1)
            .concat([{}])
            .concat(prizeList.slice(targetIdx + 1));
          $list.data("prize-list", newPrizeList);
        });

        $list.on("click", ".remove-btn", function (e) {
          /** @type {Array} **/
          const prizeListData = $list.data("prize-list");
          if (prizeListData.length <= 1) {
            alert("最少保持一项");
            return;
          }
          // 找到最近的复合要求的数据然后
          const targetItem = $(e.target).closest(".item");
          const targetIdx = $("#list .item").index(targetItem);
          if (targetIdx == -1) return;
          targetItem.remove();
          // 清除列表数据下的prizelist对应索引数据

          /** @type {Array} **/
          const newPrizeList = prizeListData
            .slice(0, targetIdx)
            .concat(prizeListData.slice(targetIdx + 1));
          $list.data("prize-list", newPrizeList);
        });

        // 统一的输入处理函数
        $("#list").on("input", ".name-input, .email-input", function (e) {
          const inputItem = $(e.target);
          let attrName = inputItem.hasClass("name-input") ? "name" : "email";
          const targetItem = inputItem.closest(".item");
          const targetIdx = $("#list .item").index(targetItem);
          if (targetIdx === -1) {
            console.error("cannot find idx");
            return;
          }
          const input_val = $(e.target).val();
          // 校验错误
          let error = "";
          if (attrName == "name" && !InputValidator.nameCheck(input_val)) {
            error += "姓名不能有特殊字符";
          }
          if (attrName == "email" && !InputValidator.emailCheck(input_val)) {
            error += "邮箱格式错误";
          }
          const $error = targetItem.find(".error");
          if (error !== "") {
            $error.toggleClass("none", false).text(error);
            return;
          } else {
            $error.toggleClass("none", true);
          }
          // 更新列表整体数据
          const prizelist = $list.data("prize-list");
          const prizeItemData = prizelist[targetIdx] || {};
          prizeItemData[attrName] = input_val;
          prizelist[targetIdx] = prizeItemData;
          $list.data("prize-list", prizelist);
        });
        // 当用户退出编辑输入失去焦点的时候检查输入
        $("#list").on('focusout', ".name-input, .email-input", function (e) {
            checkListInput($list);
        });
        // 输出console data数据
        $("#consoleBtn").on("click", function () {
          console.log($("#list").data("prize-list"));
        });

        // 执行初始化流程
        initialList($list, $template);
      });
    </script>
  </body>
</html>
